<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="index.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-size: 1.15rem;
      font-family: Arial, sans-serif;
    }
    html {
      max-width: 70ch;
      padding: 3rem 1rem;
      margin: auto;
      line-height: 1.25;
    }
    h1 {
      font-size: 2rem;
    }
    h2 {
      font-size: 1.5rem;
    }
    input, textarea {
      line-height: 1.25;
      width: 100%;
      height: 1.8rem;
      font-size: 1.15rem;
      border: 1px solid grey;
    }
    textarea {
      height: auto;
    }
    @media screen and (max-width: 600px) {
    }
  </style>
  <script>
    var $ = document.querySelector.bind( document );
    var $$ = document.querySelectorAll.bind( document );
    var url_params = new URLSearchParams( window.location.search );
    var url_keys = url_params.keys();
    var $_GET = {}
    var timelength = 1000;
    for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
      function convert( text ) {
        var encoder = new TextEncoder().encode( text );
        return [...new Uint8Array(encoder)]
        .map( x => x.toString( 16 ).padStart( 2, "0" ) )
        .join( "" );
      }
      function waitSomeSeconds( num ) {
        return new Promise( function( resolve, reject ) {
          setTimeout( function() { resolve( "" ); }, parseInt( num ) * timelength );
        });
      }
    </script>

  </head>
  <body>
    <h1>Welcome to Satoshi Jump</h1>
    <textarea class="text_input" rows="10">This is a test</textarea>
    <button class="send">Send</button>
    <script>
      var time = 0.5;
      var timeover2 = time / 2;
      // var timeover2 = time;
      var responseTimeoutDelay = 5;
      var binary = "";
      var frame = {}
      frame[ "init" ] = 0;
      frame[ "length" ] = 8;
      frame[ "message" ] = "";
      frame[ "duration" ] = frame[ "length" ] * time;
      frame[ "status" ] = 0;

      async function sendPacket( binary ) {
        //start, size, data, checksum
        binary = "G" + binary.toUpperCase() + "J";
        return new Promise( function( resolve, reject ) {
          for ( let i=0; i<binary.length; i++ ) {
            (function(i) {
              setTimeout(function() {
                console.log(i + ">" + binary[i] + "\n");
                if ( Number( binary[i] ) == 0 ) {
                  playSound("Sine", 941, timeover2);
                  playSound("Sine", 1336, timeover2);
                }
                if ( Number( binary[i] ) == 1 ) {
                  playSound("Sine", 697, timeover2);
                  playSound("Sine", 1209, timeover2);
                }
                if ( Number( binary[i] ) == 2 ) {
                  playSound("Sine", 697, timeover2);
                  playSound("Sine", 1336, timeover2);
                }
                if ( Number( binary[i] ) == 3 ) {
                  playSound("Sine", 697, timeover2);
                  playSound("Sine", 1447, timeover2);
                }
                if ( Number( binary[i] ) == 4 ) {
                  playSound("Sine", 770, timeover2);
                  playSound("Sine", 1209, timeover2);
                }
                if ( Number( binary[i] ) == 5 ) {
                  playSound("Sine", 770, timeover2);
                  playSound("Sine", 1336, timeover2);
                }
                if ( Number( binary[i] ) == 6 ) {
                  playSound("Sine", 770, timeover2);
                  playSound("Sine", 1447, timeover2);
                }
                if ( Number( binary[i] ) == 7 ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1209, timeover2);
                }
                if ( Number( binary[i] ) == 8 ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1336, timeover2);
                }
                if ( Number( binary[i] ) == 9 ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1447, timeover2);
                }
                if ( binary[i] == "A" ) {
                  playSound("Sine", 697, timeover2);
                  playSound("Sine", 1633, timeover2);
                }
                if ( binary[i] == "B" ) {
                  playSound("Sine", 770, timeover2);
                  playSound("Sine", 1633, timeover2);
                }
                if ( binary[i] == "C" ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1633, timeover2);
                }
                if ( binary[i] == "D" ) {
                  playSound("Sine", 941, timeover2);
                  playSound("Sine", 1633, timeover2);
                }
                if ( binary[i] == "E" ) {
                  playSound("Sine", 941, timeover2);
                  playSound("Sine", 1209, timeover2);
                }
                if ( binary[i] == "F" ) {
                  playSound("Sine", 941, timeover2);
                  playSound("Sine", 1477, timeover2);
                }
                //start
                if ( binary[i] == "G" ) {
                  playSound("Sine", 697, timeover2);
                  playSound("Sine", 1776, timeover2);
                }
                //ack
                if ( binary[i] == "H" ) {
                  playSound("Sine", 697, timeover2);
                  playSound("Sine", 1913, timeover2);
                }
                //nack
                if ( binary[i] == "I" ) {
                  playSound("Sine", 770, timeover2);
                  playSound("Sine", 1776, timeover2);
                }
                //stop
                if ( binary[i] == "J" ) {
                  playSound("Sine", 770, timeover2);
                  playSound("Sine", 1913, timeover2);
                }
                //size
                if ( binary[i] == "K" ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1776, timeover2);
                }
                //res1
                if ( binary[i] == "L" ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1913, timeover2);
                }
                //res2
                if ( binary[i] == "M" ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1776, timeover2);
                }
                //res3
                if ( binary[i] == "N" ) {
                  playSound("Sine", 852, timeover2);
                  playSound("Sine", 1913, timeover2);
                }
                if ( i == binary.length - 1 ) resolve( "message sent" );
              }, time * timelength * ( i + 1 ) )
            })(i);
          }
        });
      }

      async function sendRecursively() {
        frame[ "message" ] = binary.substring( frame[ "init" ], frame[ "init" ] + frame[ "length" ] );
        console.log( "binary:", binary );
        console.log( "message:", frame[ "message" ] );
        var sent = await sendPacket( binary );
        //var sent = await sendPacket( frame[ "message" ] );
        console.log( sent );
        //todo: don't wait 5 seconds if they give us an ack right away
        console.log("waiting..." );
        await waitSomeSeconds( 5 );
        if ( !frame[ "status" ] ) {
          //sendRecursively();
        } else {
          frame[ "status" ] = 0;
          frame[ "init" ] = frame[ "init" ] + frame[ "length" ];
          sendRecursively();
        }
      }

      $( '.send' ).onclick = async function() {
        binary = convert( $( '.text_input' ).value );
        sendRecursively();
      }
    </script>
  </body>
  </html>
